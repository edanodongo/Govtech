{% extends "dashboard/index.html" %}
{% load custom_filters %}
{% load static %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-4">
  <h2>Platform Statistics</h2>

    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card flex-row align-items-center">
          <div class="card-body d-flex align-items-center">
            <div class="me-3">
              <span class="badge bg-light-primary border border-primary fs-3"><i class="ti ti-trending-up"></i></span>
            </div>
            <div>
              <h6 class="mb-1 f-w-400 text-muted">Software Firms</h6>
              <h4 class="mb-0">{{ total_companies }} </h4>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card flex-row align-items-center">
          <div class="card-body d-flex align-items-center">
            <div class="me-3">
              <span class="badge bg-light-success border border-success fs-3"><i class="ti ti-trending-up"></i></span>
            </div>
            <div>
              <h6 class="mb-1 f-w-400 text-muted">Developers</h6>
              <h4 class="mb-0">{{ total_individuals }} </h4>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Profile Panel (if its a developer)-->

  <!-- Developer Registrations Table -->
  {% if devss %}
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">Developer Profiles</h4>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Email</th>
              <th>First Name</th>
              <th>Second Name</th>
              <th>ID Number</th>
              <th>Industry</th>
              <th>Nature</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for dev in devss %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ dev.user.email }}</td>
              <td>{{ dev.first_name }}</td>
              <td>{{ dev.second_name }}</td>
              <td>{{ dev.id_number }}</td>
              <td>{{ dev.industry }}</td>
              <td>{{ dev.nature }}</td>
              <td>
                <span class="badge bg-warning text-dark">pending</span>
              </td>
              <td>
                <a href="{% url 'edit_dev' dev.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="alert alert-warning">No developer profiles found.</div>
  {% endif %}

  <!-- Profile Panel (if its a company)-->

  <!-- Company Registrations Table -->
  <br>
    {% if regss %}      
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Company Profiles</h4>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Company</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Stage</th>
                <th>Sector</th>
                <th>Business Model</th>
                <th>Website</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for reg in regss %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ reg.company_name }}</td>
                <td>{{ reg.official_email }}</td>
                <td>{{ reg.phone_number }}</td>
                <td>{{ reg.stage }}</td>
                <td>{{ reg.sector }}</td>
                <td>{{ reg.business_model }}</td>
                <td>{{ reg.website }}</td>
                <td>
                  <span class="badge bg-warning text-dark">pending</span>
                </td>
                <td>
                <a href="{% url 'edit_reg' reg.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning">No company registrations found.</div>
    {% endif %}
  <br>
    

  <!-- Filter Form -->
  <form method="get" class="mb-4 p-3 border rounded bg-light">
    <div class="row g-3">
      <div class="col-md-3">
        <label>Start Date</label>
        {{ form.start_date }}
      </div>
      <div class="col-md-3">
        <label>End Date</label>
        {{ form.end_date }}
      </div>
      <div class="col-md-3">
        <label>Company Sector</label>
        {{ form.sector }}
      </div>
      <div class="col-md-3">
        <label>Developer Industry</label>

        {{ form.industry }}
      </div>
    </div>
    <div class="mt-3 text-end">
      <button type="submit" class="btn btn-primary">Filter</button>
      <a href="{% url 'dashboard_stats' %}" class="btn btn-secondary">Reset</a>
    </div>
  </form>

  <!-- Charts -->
  <div class="row mb-4">
    <div class="col-md-6">
      <h5>Developer Natures</h5>
      <canvas id="devNatureChart"></canvas>
    </div>
    <div class="col-md-6">
      <h5>Top Developer Industries</h5>
      <canvas id="industryChart"></canvas>
    </div>
  </div>
</div>

<!-- Chart Data Script -->
<script>
  const companyStageData = {
    labels: {{ company_by_stage|map_attr:"stage"|safe }},
    datasets: [{
      label: 'Companies',
      data: {{ company_by_stage|map_attr:"count"|safe }},
      backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1']
    }]
  };

  const businessModelData = {
    labels: {{ company_by_model|map_attr:"business_model"|safe }},
    datasets: [{
      label: 'Business Models',
      data: {{ company_by_model|map_attr:"count"|safe }},
      backgroundColor: '#17a2b8'
    }]
  };

  const devNatureData = {
    labels: {{ dev_by_nature|map_attr:"nature"|safe }},
    datasets: [{
      label: 'Developer Natures',
      data: {{ dev_by_nature|map_attr:"count"|safe }},
      backgroundColor: ['#ffc107', '#20c997', '#fd7e14', '#6610f2', '#6c757d']
    }]
  };

  const industryData = {
    labels: {{ dev_by_industry|map_attr:"industry"|safe }},
    datasets: [{
      label: 'Top Industries',
      data: {{ dev_by_industry|map_attr:"count"|safe }},
      backgroundColor: '#343a40'
    }]
  };

  new Chart(document.getElementById('companyStageChart'), { type: 'pie', data: companyStageData });
  new Chart(document.getElementById('businessModelChart'), { type: 'bar', data: businessModelData, options: { indexAxis: 'y' } });
  new Chart(document.getElementById('devNatureChart'), { type: 'pie', data: devNatureData });
  new Chart(document.getElementById('industryChart'), { type: 'bar', data: industryData, options: { indexAxis: 'y' } });
</script>

{% endblock %}

